{"paragraphs":[{"text":"%md\n# Blade&Soul user's churn prediction\n\n## Introcution\n\n![Blade&Soul](http://static.plaync.co.kr/gaiaupload/BladeNSoul/bbs/201306/wallpaper220130619115913.jpg)\nBlade&Soul is Oriental fantasy massively multiplayer online role playing game (MMORPG) developed by NCSOFT. \nUnlike telecommunication services, **online game services cannot define an explicit deregistration as a churn.** According to ncsoft's analysis, deregistration users are no more than 1% of the long-term unconnected users who are assumed to have left the game service. Therefore, the long-term unconnected state should be redefined as a churn.\nNCSOFT defined a user who does not play a game for more than five weeks as a churn. In this data, however, the churn criteria was reduced by three weeks.\n![ChurnCriteria](https://cilab.sejong.ac.kr/gdmc2017/wp-content/uploads/2017/04/fig2.png)\n\n## How to predict user who left the game\n\n### Overview\n\n![RNN Structure](http://t1.daumcdn.net/brunch/service/user/IgT/image/KOUKrZNca-XlF0gNKntfOSgzsbs.png)\n\nWe will use 'LSTM(long short term memory)' network to predict chrun. LSTM is a kind of RNN(Recurrent neural network).\nUnlike DNN, RNN can learn sequential data because of its structure. In RNN's hidden layer, there is weight which feeds itself. When calculates hidden layer's value, rnn uses (current input*weight) and (prev hidden layer's value*weight which feeds itself). So, RNN's learning mechanism uses current data,but also prev data.\n\n![LSTM Structure](http://t1.daumcdn.net/brunch/service/user/IgT/image/I0UJ8f2U5ePsX3LU-kJS--yIarU.png)\n\nBut, RNN also has problem which called long-term dependency.If input sequence is too long, RNN has affected by last data more and affected by prev data little.\nLSTM can solve this problem by its specific structure.\n\n### Input data\n\nGame server leaves 'game log' which is created by user's action. There are many game log type in NCSOFT's game log.\nWe will use some game log types below.\n\n|  Category   | LogID | LogName       | Description                                     |\n|-------------|-------|---------------|-------------------------------------------------|\n| Connection  |  1003 | EnterWorld    | When user enters the game-server                |\n| Connection  |  1004 | LeaveWorld    | When user leaves the game-server                |\n| Connection  |  1005 | EnterZone     | When user enters the zone                       |\n| Connection  |  1006 | LeaveZone     | When user leaves the zone                       | \n| Connection  |  1010 | Teleport      | When user teleported using the magical method   |\n| Connection  |  1013 | PCLevelUp     | When user’s character leveled up                |\n| Character   |  1016 | GetExperience | When actor gets Exp                             |\n| Character   |  1022 | GetItem       | When the items in the inventory are increased   |\n| Character   |  1102 | JoinParty     | When user joined the party                      |\n| Character   |  1202 | Die           | When actor died                                 |\n| Character   |  1209 | KillPC        | When actor killed PC                            |\n\nWe have to pre-process this data. We will group data with 'userId' and 'date'.\nBut there is too many data to pre-process, so we will choose some userId to use.\n\n![USER_LOG_LSTM_NETWORK](https://user-images.githubusercontent.com/7621901/32683884-1eec7aee-c6c2-11e7-993b-990d1464de87.png)\n\n![NETWORK_QUESTION](https://scontent-icn1-1.xx.fbcdn.net/v/t1.0-9/23031420_1483257105083182_4723745122961362324_n.jpg?oh=0797f636d54b130e1c5d19977dceb7ec&oe=5A6C05EB)","user":"anonymous","dateUpdated":"2017-11-11T20:23:12+0900","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h1>Blade&amp;Soul user&rsquo;s churn prediction</h1>\n<h2>Introcution</h2>\n<p><img src=\"http://static.plaync.co.kr/gaiaupload/BladeNSoul/bbs/201306/wallpaper220130619115913.jpg\" alt=\"Blade&amp;Soul\" /><br/>Blade&amp;Soul is Oriental fantasy massively multiplayer online role playing game (MMORPG) developed by NCSOFT.<br/>Unlike telecommunication services, <strong>online game services cannot define an explicit deregistration as a churn.</strong> According to ncsoft&rsquo;s analysis, deregistration users are no more than 1% of the long-term unconnected users who are assumed to have left the game service. Therefore, the long-term unconnected state should be redefined as a churn.<br/>NCSOFT defined a user who does not play a game for more than five weeks as a churn. In this data, however, the churn criteria was reduced by three weeks.<br/><img src=\"https://cilab.sejong.ac.kr/gdmc2017/wp-content/uploads/2017/04/fig2.png\" alt=\"ChurnCriteria\" /></p>\n<h2>How to predict user who left the game</h2>\n<h3>Overview</h3>\n<p><img src=\"http://t1.daumcdn.net/brunch/service/user/IgT/image/KOUKrZNca-XlF0gNKntfOSgzsbs.png\" alt=\"RNN Structure\" /></p>\n<p>We will use &lsquo;LSTM(long short term memory)&rsquo; network to predict chrun. LSTM is a kind of RNN(Recurrent neural network).<br/>Unlike DNN, RNN can learn sequential data because of its structure. In RNN&rsquo;s hidden layer, there is weight which feeds itself. When calculates hidden layer&rsquo;s value, rnn uses (current input*weight) and (prev hidden layer&rsquo;s value*weight which feeds itself). So, RNN&rsquo;s learning mechanism uses current data,but also prev data.</p>\n<p><img src=\"http://t1.daumcdn.net/brunch/service/user/IgT/image/I0UJ8f2U5ePsX3LU-kJS--yIarU.png\" alt=\"LSTM Structure\" /></p>\n<p>But, RNN also has problem which called long-term dependency.If input sequence is too long, RNN has affected by last data more and affected by prev data little.<br/>LSTM can solve this problem by its specific structure.</p>\n<h3>Input data</h3>\n<p>Game server leaves &lsquo;game log&rsquo; which is created by user&rsquo;s action. There are many game log type in NCSOFT&rsquo;s game log.<br/>We will use some game log types below.</p>\n<table>\n  <thead>\n    <tr>\n      <th>Category </th>\n      <th>LogID </th>\n      <th>LogName </th>\n      <th>Description </th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>Connection </td>\n      <td>1003 </td>\n      <td>EnterWorld </td>\n      <td>When user enters the game-server </td>\n    </tr>\n    <tr>\n      <td>Connection </td>\n      <td>1004 </td>\n      <td>LeaveWorld </td>\n      <td>When user leaves the game-server </td>\n    </tr>\n    <tr>\n      <td>Connection </td>\n      <td>1005 </td>\n      <td>EnterZone </td>\n      <td>When user enters the zone </td>\n    </tr>\n    <tr>\n      <td>Connection </td>\n      <td>1006 </td>\n      <td>LeaveZone </td>\n      <td>When user leaves the zone </td>\n    </tr>\n    <tr>\n      <td>Connection </td>\n      <td>1010 </td>\n      <td>Teleport </td>\n      <td>When user teleported using the magical method </td>\n    </tr>\n    <tr>\n      <td>Connection </td>\n      <td>1013 </td>\n      <td>PCLevelUp </td>\n      <td>When user’s character leveled up </td>\n    </tr>\n    <tr>\n      <td>Character </td>\n      <td>1016 </td>\n      <td>GetExperience </td>\n      <td>When actor gets Exp </td>\n    </tr>\n    <tr>\n      <td>Character </td>\n      <td>1022 </td>\n      <td>GetItem </td>\n      <td>When the items in the inventory are increased </td>\n    </tr>\n    <tr>\n      <td>Character </td>\n      <td>1102 </td>\n      <td>JoinParty </td>\n      <td>When user joined the party </td>\n    </tr>\n    <tr>\n      <td>Character </td>\n      <td>1202 </td>\n      <td>Die </td>\n      <td>When actor died </td>\n    </tr>\n    <tr>\n      <td>Character </td>\n      <td>1209 </td>\n      <td>KillPC </td>\n      <td>When actor killed PC </td>\n    </tr>\n  </tbody>\n</table>\n<p>We have to pre-process this data. We will group data with &lsquo;userId&rsquo; and &lsquo;date&rsquo;.<br/>But there is too many data to pre-process, so we will choose some userId to use.</p>\n<p><img src=\"https://user-images.githubusercontent.com/7621901/32683884-1eec7aee-c6c2-11e7-993b-990d1464de87.png\" alt=\"USER_LOG_LSTM_NETWORK\" /></p>\n<p><img src=\"https://scontent-icn1-1.xx.fbcdn.net/v/t1.0-9/23031420_1483257105083182_4723745122961362324_n.jpg?oh=0797f636d54b130e1c5d19977dceb7ec&oe=5A6C05EB\" alt=\"NETWORK_QUESTION\" /></p>\n</div>"}]},"apps":[],"jobName":"paragraph_1509982150399_1013722248","id":"20171107-002910_866868944","dateCreated":"2017-11-07T00:29:10+0900","dateStarted":"2017-11-11T20:23:12+0900","dateFinished":"2017-11-11T20:23:14+0900","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:104"},{"text":"//Setting log directory\n//You have to change PROJECT_HOME\nval PROJECT_HOME=\"/Users/leeyh0216/Documents/projects/bns_churn_prediction\"\nval gamelogDir = s\"$PROJECT_HOME/data/gamelog\"\nval aggregateResultDir = s\"$PROJECT_HOME/data/aggregate\"\n    \nspark.sqlContext.read\n    .format(\"com.databricks.spark.csv\")\n    .option(\"header\", \"true\")\n    .option(\"inferSchema\", \"true\")\n    .load(s\"$gamelogDir/*/*/*\")\n    .withColumn(\"time\", date_format(col(\"time\"), \"yyyy-MM-dd\"))\n    .groupBy(\"actor_account_id\",\"time\")\n    .agg(\n        count(\"*\").as(\"logCnt\")\n        ,max(col(\"actor_level\")).as(\"maxLevel\")\n        ,max(col(\"actor_masterylevel\")).as(\"maxMasteryLevel\")\n        ,count(when($\"logid\" === 1102, true)).as(\"partyCnt\")\n        ,count(when($\"logid\" === 1209, true)).as(\"killCnt\")\n        ,count(when($\"logid\" === 1202, true)).as(\"deadCnt\")\n        ,count(when($\"logid\" === 1016, true)).as(\"expCnt\")\n    )\n    .coalesce(20)\n    .write\n    .option(\"header\", \"true\")\n    .option(\"delimiter\",\",\").csv(aggregateResultDir)\n        ","user":"anonymous","dateUpdated":"2017-11-11T20:22:31+0900","config":{"colWidth":12,"enabled":true,"results":{"1":{"graph":{"mode":"lineChart","height":300,"optionOpen":true,"setting":{"lineChart":{}},"commonSetting":{},"keys":[{"name":"time","index":1,"aggr":"sum"}],"groups":[],"values":[{"name":"deadCnt","index":7,"aggr":"sum"},{"name":"maxLevel","index":2,"aggr":"sum"},{"name":"maxMasteryLevel","index":3,"aggr":"sum"},{"name":"logCnt","index":4,"aggr":"sum"},{"name":"partyCnt","index":5,"aggr":"sum"},{"name":"killCnt","index":6,"aggr":"sum"}]},"helium":{}}},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"PROJECT_HOME: String = /Users/leeyh0216/Documents/projects/bns_churn_prediction\ngamelogDir: String = /Users/leeyh0216/Documents/projects/bns_churn_prediction/data/gamelog\nuserIdDir: String = /Users/leeyh0216/Documents/projects/bns_churn_prediction/data/train_user_data\naggregateResultDir: String = /Users/leeyh0216/Documents/projects/bns_churn_prediction/data/aggregate\n"}]},"apps":[],"jobName":"paragraph_1509981131758_1278376940","id":"20171107-001211_103261054","dateCreated":"2017-11-07T00:12:11+0900","dateStarted":"2017-11-11T19:31:33+0900","dateFinished":"2017-11-11T20:16:42+0900","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:106"},{"text":"","user":"anonymous","dateUpdated":"2017-11-11T20:22:37+0900","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1510362379399_-1741194642","id":"20171111-100619_971704847","dateCreated":"2017-11-11T10:06:19+0900","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:114","errorMessage":""}],"name":"gamelog_aggregation","id":"2CXZTGS19","angularObjects":{"2CZQ929U1:shared_process":[],"2CZ2BP9YT:shared_process":[],"2D13ZNWTZ:shared_process":[],"2CZ664G9R:shared_process":[],"2D13ZRY18:shared_process":[],"2CYCGTMNX:shared_process":[],"2CX1Q558A:shared_process":[],"2CZUMJG36:shared_process":[],"2CYSMCYZD:shared_process":[],"2CZ9BKJ7J:shared_process":[],"2D16W85TB:shared_process":[],"2CXCMVV9G:shared_process":[],"2CZTPFH3E:shared_process":[],"2CZXBZRG8:shared_process":[],"2CY17A9BR:shared_process":[],"2CWYDQABW:shared_process":[],"2CZ3NBJHK:shared_process":[],"2CZMGTJ4P:shared_process":[],"2CZG82XFJ:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}